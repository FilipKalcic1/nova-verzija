# =============================================================================
# MobilityOne WhatsApp Bot - Environment Configuration
# Version: 3.0 - Complete Production Configuration
# =============================================================================
# Kopiraj u .env i popuni stvarnim vrijednostima!
# NIKADA ne commitaj .env u git!
# =============================================================================

# =============================================================================
# ENVIRONMENT
# =============================================================================
APP_ENV=development                    # development | staging | production
DEBUG=true                             # true | false (disable in production!)

# =============================================================================
# DATABASE - DUAL-USER SECURITY MODEL
# =============================================================================
# PostgreSQL superuser (used by migrations/init scripts only)
DB_PASSWORD=your-postgres-admin-password

# BOT USER (LIMITED ACCESS)
# - Can access: user_mappings, conversations, messages, tool_executions
# - Can INSERT: hallucination_reports (to record "krivo" feedback)
# - CANNOT access: audit_logs, hallucination_reports (read/update/delete)
BOT_DB_PASSWORD=your-bot-db-password
BOT_DATABASE_URL=postgresql+asyncpg://bot_user:your-bot-db-password@postgres:5432/mobility_db

# ADMIN USER (FULL ACCESS)
# - Full access to ALL tables including audit_logs, hallucination_reports
# - Used only by admin-api service
ADMIN_DB_PASSWORD=your-admin-db-password
ADMIN_DATABASE_URL=postgresql+asyncpg://admin_user:your-admin-db-password@postgres:5432/mobility_db

# Legacy (backward compatibility - will use BOT_DATABASE_URL if set)
DATABASE_URL=postgresql+asyncpg://bot_user:your-bot-db-password@postgres:5432/mobility_db

# --- CONNECTION POOLING ---
DB_POOL_SIZE=10
DB_MAX_OVERFLOW=20
DB_POOL_RECYCLE=3600

# =============================================================================
# CONFIG STORAGE MODE
# =============================================================================
# Where to store dynamic config (tool registry, knowledge graph)
# true = PostgreSQL database (recommended for production)
# false = JSON files in config/ directory
USE_DATABASE_CONFIG=true
USE_DB_KNOWLEDGE=true
USE_DB_TOOLS=true

# =============================================================================
# REDIS
# =============================================================================
REDIS_URL=redis://redis:6379/0
REDIS_PASSWORD=                        # Leave empty if no auth, or set password
REDIS_MAX_CONNECTIONS=50

# =============================================================================
# INFOBIP (WhatsApp Provider)
# =============================================================================
INFOBIP_BASE_URL=xxxxx.api.infobip.com           # Your Infobip subdomain
INFOBIP_API_KEY=your-infobip-api-key             # API key from Infobip dashboard
INFOBIP_SENDER_NUMBER=385xxxxxxxxx               # WhatsApp sender number
INFOBIP_SECRET_KEY=your-webhook-secret-key       # For webhook signature validation

# =============================================================================
# AZURE OPENAI (LLM + Embeddings)
# =============================================================================
OPENAI_API_TYPE=azure
AZURE_OPENAI_ENDPOINT=https://your-instance.openai.azure.com/
AZURE_OPENAI_API_KEY=your-azure-openai-api-key
AZURE_OPENAI_API_VERSION=2024-08-01-preview

# Deployment names (must match your Azure deployments!)
AZURE_OPENAI_DEPLOYMENT_NAME=gpt-4o-mini         # Chat/completion model
AZURE_OPENAI_EMBEDDING_DEPLOYMENT=text-embedding-ada-002  # Embedding model

# AI Configuration
AI_CONFIDENCE_THRESHOLD=0.85           # Minimum confidence for tool execution

# =============================================================================
# MOBILITY ONE (Backend API)
# =============================================================================
# Base URL of MobilityOne instance
MOBILITY_API_URL=https://your-instance.mobilityone.io/

# Swagger definition URL (bot reads this to learn available tools)
SWAGGER_URL=https://your-instance.mobilityone.io/automation/swagger/v1.0.0/swagger.json

# OAuth2 Authentication
MOBILITY_AUTH_URL=https://your-instance.mobilityone.io/sso/connect/token
MOBILITY_CLIENT_ID=your-client-id
MOBILITY_CLIENT_SECRET=your-client-secret
MOBILITY_TENANT_ID=your-tenant-uuid

# Legacy (leave empty - bot gets token automatically using above credentials)
MOBILITY_API_TOKEN=
MOBILITY_AUDIENCE=none

# =============================================================================
# MONITORING
# =============================================================================
GRAFANA_PASSWORD=your-grafana-password
SENTRY_DSN=https://xxx@xxx.ingest.sentry.io/xxx  # Optional: Error tracking

# =============================================================================
# ADMIN API (Feedback Loop Dashboard)
# =============================================================================
# Generate secure tokens with: openssl rand -hex 32
ADMIN_TOKEN_1=generate-64-char-hex-token-here
ADMIN_TOKEN_1_USER=admin.username
ADMIN_TOKEN_2=generate-another-64-char-hex-token
ADMIN_TOKEN_2_USER=another.admin

# IP Whitelist for Admin API (CIDR format, comma separated)
ADMIN_ALLOWED_IPS=10.0.0.0/8,192.168.0.0/16

# Rate limiting
ADMIN_RATE_LIMIT_PER_MINUTE=30

# =============================================================================
# PRODUCTION ONLY
# =============================================================================
# SSL/TLS (for Traefik/Let's Encrypt)
ACME_EMAIL=admin@yourdomain.com

# Worker scaling
WORKER_REPLICAS=2                      # Number of worker containers

# =============================================================================
# DOCKER NETWORK NOTES
# =============================================================================
# In docker-compose, use service names:
#   - postgres:5432 (not localhost!)
#   - redis:6379 (not localhost!)
#
# For local development without Docker:
#   - localhost:5432
#   - localhost:6379
#
# =============================================================================

# =============================================================================
# SECURITY NOTES
# =============================================================================
# 1. Generate strong passwords (min 32 characters):
#    openssl rand -base64 32
#
# 2. DUAL-USER SECURITY:
#    Bot API uses bot_user which CANNOT access admin tables.
#    If bot is compromised via prompt injection,
#    attacker CANNOT access audit logs or hallucination reports!
#
# 3. ADMIN API:
#    - Bind to 127.0.0.1 only (not 0.0.0.0)
#    - Use VPN or internal network
#    - Never expose to public internet!
#
# 4. SECRETS:
#    - Never commit .env to git
#    - Use environment variables in production
#    - Rotate tokens periodically
# =============================================================================
